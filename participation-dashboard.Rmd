---
title: "NLP Sandbox Participation Dashboard"
author: "Andrew Lamb"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
---

```{r setup, include=FALSE}
library(flexdashboard)
library(magrittr)
```

```{r, message=FALSE, include=FALSE}
synapser::synLogin()
submission_table <- "select * from syn23633030" %>% 
  synapser::synTableQuery() %>% 
  purrr::pluck("filepath") %>% 
  readr::read_csv() %>% 
  dplyr::mutate(
    "datetime" = lubridate::as_datetime(
      .data$createdOn/1000, origin = "1970-01-01"
    ),
    "date" = lubridate::ymd(lubridate::floor_date(.data$datetime, "day")),
    "year" = forcats::as_factor(lubridate::year(.data$datetime)),
    "month" = lubridate::month(.data$datetime, label = TRUE, abbr = TRUE)
  ) 
```


Row {data-height=75}
-----------------------------------------------------------------------

### **Overview**

Submission data — from Synapse table `syn23633030` — was downloaded using the `synapser` package for R on `r lubridate::now("UTC")` UTC. 



Row
-----------------------------------------------------------------------

### Number of Tasks Open

```{r}
n_unique_tasks     <- length(unique(submission_table$evaluationid))
flexdashboard::valueBox(n_unique_tasks , icon = "fa-cogs")
```

### Number of Submitters

```{r}
n_unique_submitters <- length(unique(submission_table$submitterid))
flexdashboard::valueBox(n_unique_submitters, icon = "fa-cogs")
```


Row
-----------------------------------------------------------------------
### Latest version of the NLP Sandbox schemas

```{r}
version <- gh::gh("GET /repos/nlpsandbox/nlpsandbox-schemas/releases")[[1]]$tag_name
flexdashboard::valueBox(version, icon = "fa-cogs")
```


### Number of Tools

```{r}
n_unique_tools      <- length(unique(submission_table$tool__name))
flexdashboard::valueBox(n_unique_tools, icon = "fa-cogs")
```



Row
-----------------------------------------------------------------------

### Number of Datasets

```{r}
n_unique_datasets   <- length(unique(submission_table$dataset_name))
flexdashboard::valueBox(n_unique_datasets, icon = "fa-cogs")
```

### Number of Data sites

```{r}
flexdashboard::valueBox(2, icon = "fa-cogs")
```

Row
-----------------------------------------------------------------------

### Number of submissions per month in the last year.

```{r}
n_submission_table <- submission_table %>% 
  dplyr::filter(.data$datetime > (lubridate::now() - lubridate::years(1))) %>% 
  dplyr::group_by(.data$month) %>% 
  dplyr::tally()


  n_submission_plot <- plotly::plot_ly(
    n_submission_table,
    x = ~month,
    y = ~n
  )

n_submission_plot

```

Row {data-height=50}
-----------------------------------------------------------------------

### **Submission Breakdowns**

Switch between tabs below to view the breakdown of successful submissions by platform, environment, or team.

Row  {.tabset .tabset-fade}
-----------------------------------------------------------------------

```{r, include=FALSE}
# plot_workflow_breakdown <- function(groupvar) {
#     submission_df <- valid_clean_df
#     fill_vals <- unique(submission_df[["workflow"]])
#     bar_vals <- unique(submission_df[[names(groupvar)]])
#     num_bars <- length(bar_vals)
#     
#     fill_margin <- max(purrr::map_int(fill_vals, stringr::str_length))
#     bar_margin <- max(purrr::map_int(bar_vals, stringr::str_length))
#     
#     groupcol = as.name(names(groupvar))
#     plot_df <- submission_df %>% 
#         group_by(.dots = c("workflow", names(groupvar))) %>% 
#         tally() %>% 
#         mutate(label = glue::glue("<b><i>{workflow}</i></b><br>[{groupvar}] <b>{group}</b>: {count} submissions",
#                                   workflow = workflow, 
#                                   groupvar = as.character(groupvar),
#                                   group = rlang::UQ(groupcol),
#                                   count = n))
#     
#     p <- plot_df %>% 
#         ggplot(aes_string(x = names(groupvar), y = "n", text = "label")) +
#         geom_col(aes(fill = workflow), alpha = 0.8, colour = "black", size = 0.2) +
#         scale_fill_viridis(discrete = TRUE) +
#         coord_flip() +
#         xlab("") +
#         ylab("") +
#         custom_theme_bw() +
#         theme(plot.title = element_text(face = "bold"),
#               legend.title = element_blank()) +
#         ggtitle(glue::glue("Workflows by {groupvar}", 
#                            groupvar = as.character(groupvar)))
#     ggplotly(p, tooltip = "text") %>%
#         layout(margin = list(l = 12 + bar_margin * 6,
#                              r = 10 + fill_margin * 6),
#                font = list(family = "Roboto, Open Sans, sans-serif"))
# }
```

### Platform

```{r, warning=FALSE, message=FALSE}
# plot_workflow_breakdown(groupvar = list(platform = "Platform"))
```

### Environment

```{r, message=FALSE, warning=FALSE}
# plot_workflow_breakdown(groupvar = list(environment = "Environment"))
```

### Team

```{r, message=FALSE, warning=FALSE}
# plot_workflow_breakdown(groupvar = list(team = "Team"))
```


### Type

```{r, message=FALSE, warning=FALSE}
# plot_workflow_breakdown(groupvar = list(workflow_type = "Type"))
```

